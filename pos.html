<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>POS & Cart - Medical System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @media print {

            /* Basic page setup for print */
            body {
                background-color: white !important;
                color: black !important;
                height: auto !important;
                overflow: visible !important;
            }

            /* Hide unnecessary elements */
            aside,
            .search-container,
            button,
            .action-col {
                display: none !important;
            }

            /* Hide rows that have normal stock */
            .hide-normal-stock {
                display: none !important;
            }

            /* Adjust main container */
            main {
                padding: 0 !important;
                width: 100% !important;
                flex: none !important;
            }

            /* Make text dark for readability */
            .text-white,
            .text-gray-300,
            .text-gray-400,
            .text-gray-500,
            .text-blue-100,
            .text-green-100,
            .text-orange-100,
            .text-purple-100,
            .text-blue-200,
            .text-green-200,
            .text-orange-200,
            .text-purple-200 {
                color: black !important;
            }

            /* Adjust cards for print */
            .grid>div {
                background-color: white !important;
                border: 1px solid #ccc !important;
                box-shadow: none !important;
                color: black !important;
            }

            .grid i {
                color: black !important;
            }

            /* Adjust Table for print */
            .bg-\[\#1e293b\],
            .bg-\[\#334155\] {
                background-color: transparent !important;
                border: none !important;
                box-shadow: none !important;
            }

            table {
                width: 100%;
                border-collapse: collapse;
            }

            th,
            td {
                border-bottom: 1px solid #ddd !important;
                color: black !important;
            }

            th {
                background-color: #f3f4f6 !important;
            }

            /* Hide the Actions column completely */
            th.action-col,
            td.action-col {
                display: none !important;
            }
        }
    </style>
</head>

<body class="bg-[#0f172a] text-white font-sans flex h-screen overflow-hidden relative">

    <div id="toast-notification"
        class="fixed top-5 right-5 bg-[#22c55e] text-white px-6 py-4 rounded-lg shadow-2xl transform transition-transform duration-300 translate-x-[150%] z-[100] flex items-center gap-3 border border-green-400">
        <i class="fas fa-check-circle text-2xl"></i>
        <div>
            <h4 class="font-bold text-sm">Success!</h4>
            <p id="toast-message" class="text-xs mt-0.5 text-green-100"></p>
        </div>
    </div>

    <div id="viewCartModal" class="fixed inset-0 bg-black/60 hidden flex items-center justify-center z-[60] p-4">
        <div class="bg-[#1e293b] rounded-xl shadow-2xl w-full max-w-2xl border border-gray-700 overflow-hidden">
            <div class="p-4 border-b border-gray-700 flex justify-between items-center bg-[#0f172a]">
                <h3 class="text-lg font-bold text-blue-400"><i class="fas fa-list-ul mr-2"></i> Review Cart Items</h3>
                <button onclick="closeCartModal()" class="text-gray-400 hover:text-white text-2xl">&times;</button>
            </div>
            <div class="p-6 overflow-y-auto max-h-[50vh]">
                <table class="w-full text-left">
                    <thead>
                        <tr class="text-gray-400 text-xs uppercase border-b border-gray-700">
                            <th class="pb-3">Medicine</th>
                            <th class="pb-3 text-center">Quantity</th>
                            <th class="pb-3 text-right">Price</th>
                            <th class="pb-3 text-right">Total</th>
                            <th class="pb-3 text-center">Action</th>
                        </tr>
                    </thead>
                    <tbody id="modal-cart-items" class="text-sm"></tbody>
                </table>
            </div>
            <div class="p-5 bg-[#0f172a] border-t border-gray-700 flex justify-between items-center">
                <div class="text-lg font-bold text-[#22c55e]">Final Total: <span id="modal-total-display">PKR
                        0.00</span></div>
                <div class="flex gap-3">
                    <button onclick="closeCartModal()" class="bg-gray-700 px-4 py-2 rounded-lg font-bold">Close</button>
                    <button onclick="checkout()"
                        class="bg-blue-600 hover:bg-blue-700 px-6 py-2 rounded-lg font-bold flex items-center gap-2">
                        <i class="fas fa-print"></i> Complete & Print
                    </button>
                </div>
            </div>
        </div>
    </div>

    <iframe id="printFrame" style="display:none;"></iframe>

    <aside class="w-64 bg-[#1f2937] flex flex-col justify-between border-r border-gray-700 h-full flex-shrink-0">
        <div>
            <div
                class="p-4 bg-gradient-to-r from-indigo-500 to-purple-600 text-center font-bold text-sm tracking-wide shadow-md flex items-center justify-center gap-2">
                <i class="fas fa-clinic-medical text-lg"></i> Point of Sale System
            </div>
            <nav class="mt-6 flex flex-col gap-2 px-4">
                <a href="index.html"
                    class="text-gray-300 hover:bg-gray-700 py-2.5 px-4 rounded-lg flex items-center gap-3 text-sm font-medium transition-colors">
                    <i class="fas fa-home w-5"></i> Dashboard
                </a>
                <a href="pos.html"
                    class="bg-blue-600 text-white py-2.5 px-4 rounded-lg flex items-center gap-3 text-sm font-medium transition-colors">
                    <i class="fas fa-shopping-cart w-5"></i> POS
                </a>
                <a href="medicines.html"
                    class="text-gray-300 hover:bg-gray-700 py-2.5 px-4 rounded-lg flex items-center gap-3 text-sm font-medium transition-colors">
                    <i class="fas fa-pills w-5"></i> Medicines
                </a>
                <a href="customers.html"
                    class="text-gray-300 hover:bg-gray-700 py-2.5 px-4 rounded-lg flex items-center gap-3 text-sm font-medium transition-colors">
                    <i class="fas fa-users w-5"></i> Customers
                </a>
                <a href="sales-history.html"
                    class="text-gray-300 hover:bg-gray-700 py-2.5 px-4 rounded-lg flex items-center gap-3 text-sm font-medium transition-colors">
                    <i class="fas fa-file-invoice-dollar w-5"></i> Sales History
                </a>
                <a href="reports.html"
                    class="text-gray-300 hover:bg-gray-700 py-2.5 px-4 rounded-lg flex items-center gap-3 text-sm font-medium transition-colors">
                    <i class="fas fa-chart-bar w-5"></i> Reports
                </a>
                <a href="purchase-order.html"
                    class="text-gray-300 hover:bg-gray-700 py-2.5 px-4 rounded-lg flex items-center gap-3 text-sm font-medium transition-colors">
                    <i class="fas fa-clipboard-list w-5"></i> Purchase Order
                </a>
            </nav>
        </div>

        <div class="p-3 bg-[#374151] m-4 rounded-xl flex items-center gap-3 shadow-lg">
            <div class="w-10 h-10 bg-gray-600 rounded-lg flex items-center justify-center font-bold text-lg">A</div>
            <div>
                <div class="text-sm font-bold text-white">Muhammad Uzair</div>
                <div class="text-xs text-gray-400">Administrator</div>
            </div>
        </div>
    </aside>

    <main class="flex-1 flex flex-col lg:flex-row overflow-hidden">
        <div class="flex-1 p-6 flex flex-col h-full overflow-hidden">
            <div class="mb-6 relative">
                <i class="fas fa-search absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                <input type="text" id="search-input" onkeyup="filterProducts()"
                    placeholder="Search medicines by name..."
                    class="w-full bg-[#1e293b] border border-gray-700 text-white rounded-lg py-3 pl-12 pr-4 focus:outline-none focus:border-blue-500 shadow-md">
            </div>
            <div id="products-list" class="overflow-y-auto flex-1 pr-2 flex flex-col gap-1.5 pb-20"></div>
        </div>

        <div class="w-full lg:w-80 bg-[#1e293b] border-l border-gray-700 flex flex-col h-full flex-shrink-0">
            <div class="p-5 border-b border-gray-700 shadow-sm">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold text-white flex items-center gap-2"><i
                            class="fas fa-shopping-cart text-blue-400"></i> Current Sale</h2>
                    <button onclick="openCartModal()"
                        class="text-[10px] bg-[#334155] hover:bg-blue-600 px-2 py-1 rounded text-blue-300 hover:text-white transition-colors"><i
                            class="fas fa-eye"></i> View List</button>
                </div>
                <div class="relative">
                    <label class="text-xs text-gray-400 mb-1 block uppercase font-bold tracking-wider">Customer Name
                        <span class="text-red-500">*</span></label>
                    <input type="text" id="pos-customer-input" onkeyup="searchSavedCustomers()"
                        placeholder="Find added customer..." autocomplete="off"
                        class="w-full bg-[#334155] border border-gray-600 text-white rounded-lg py-2.5 px-3 text-sm focus:outline-none focus:border-blue-500 shadow-inner">
                    <div id="customer-search-results"
                        class="absolute left-0 right-0 mt-1 bg-[#1f2937] border border-gray-700 rounded-lg shadow-xl hidden z-50 max-h-40 overflow-y-auto">
                    </div>
                    <p id="customer-error" class="text-red-400 text-[10px] mt-1 hidden italic">Customer name is
                        required!</p>
                </div>
            </div>

            <div id="cart-items-container" class="flex-1 flex flex-col p-4 overflow-y-auto gap-3">
                <div class="flex-1 flex flex-col items-center justify-center text-gray-400 h-full" id="empty-cart-msg">
                    <i class="fas fa-shopping-cart text-6xl mb-4 opacity-20"></i>
                    <p class="text-sm">Cart is empty</p>
                </div>
            </div>

            <div class="p-5 border-t border-gray-700 bg-[#1e293b]">
                <div class="flex gap-4 mb-4">
                    <div class="flex-1"><label class="text-xs text-gray-400 mb-1 block">Discount (%)</label><input
                            type="number" id="discount-input" value="0" min="0" oninput="updateCartUI()"
                            class="w-full bg-[#334155] border border-gray-600 text-white rounded-lg py-2 px-3 text-sm focus:outline-none">
                    </div>
                    <div class="flex-1"><label class="text-xs text-gray-400 mb-1 block">Tax (PKR)</label><input
                            type="number" id="tax-input" value="0" min="0" oninput="updateCartUI()"
                            class="w-full bg-[#334155] border border-gray-600 text-white rounded-lg py-2 px-3 text-sm focus:outline-none">
                    </div>
                </div>
                <div class="mb-4">
                    <label class="text-xs text-gray-400 mb-1 block">Payment Method</label>
                    <select id="pos-payment-method"
                        class="w-full bg-[#334155] border border-gray-600 text-white rounded-lg py-2 px-3 text-sm focus:outline-none appearance-none">
                        <option value="Cash">Cash</option>
                        <option value="Credit Card">Credit Card</option>
                    </select>
                </div>
                <div class="space-y-2 mb-4 text-sm font-medium">
                    <div class="flex justify-between text-gray-400"><span>Subtotal:</span><span
                            id="subtotal-display">PKR 0.00</span></div>
                    <div class="flex justify-between text-[#22c55e] font-bold border-t border-gray-700 pt-2 text-lg">
                        <span>Total:</span><span id="total-display">PKR 0.00</span></div>
                </div>
                <button onclick="checkout()"
                    class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg transition-colors flex justify-center items-center gap-2 shadow-lg"><i
                        class="fas fa-print"></i> Complete Sale</button>
            </div>
        </div>
    </main>

    <script>
        const products = [
            { id: 1, name: "Hylixia SYP", price: 295.00, stock: 10 },
            { id: 2, name: "HYLIXIA PLUS", price: 325.00, stock: 5 },
            { id: 3, name: "SYP MALTOFER", price: 370.00, stock: 8 },
            { id: 4, name: "MALTOFER DROPS", price: 358.88, stock: 15 },
            { id: 5, name: "METODINE SYP", price: 200.00, stock: 2 },
            { id: 6, name: "METODINE DF SYP", price: 135.00, stock: 2 }
        ];
        let cart = [];

        // Updated Function: Now strictly connects to your saved customers
        function searchSavedCustomers() {
            const query = document.getElementById('pos-customer-input').value.toLowerCase();
            const resultsBox = document.getElementById('customer-search-results');

            // Getting customers from the "pos_customers" storage used in customers.html
            const customers = JSON.parse(localStorage.getItem('pos_customers')) || [];

            if (query === "") { resultsBox.classList.add('hidden'); return; }

            const filtered = customers.filter(c => c.name.toLowerCase().includes(query));
            resultsBox.innerHTML = '';

            if (filtered.length > 0) {
                resultsBox.classList.remove('hidden');
                filtered.forEach(c => {
                    resultsBox.innerHTML += `<button onclick="selectCustomer('${c.name}')" class="w-full text-left p-3 hover:bg-blue-600 text-sm border-b border-gray-700 last:border-0">${c.name}</button>`;
                });
            } else {
                resultsBox.innerHTML = '<div class="p-3 text-xs text-gray-500">No saved customer found.</div>';
                resultsBox.classList.remove('hidden');
            }
        }

        function selectCustomer(name) {
            document.getElementById('pos-customer-input').value = name;
            document.getElementById('customer-search-results').classList.add('hidden');
            document.getElementById('customer-error').classList.add('hidden');
        }

        function openCartModal() {
            if (cart.length === 0) { showNotification("Cart is empty!"); return; }
            updateModalUI();
            document.getElementById('viewCartModal').classList.remove('hidden');
        }

        function closeCartModal() { document.getElementById('viewCartModal').classList.add('hidden'); }

        function updateModalUI() {
            const body = document.getElementById('modal-cart-items');
            body.innerHTML = '';
            cart.forEach(item => {
                body.innerHTML += `
                    <tr class="border-b border-gray-800">
                        <td class="py-4 text-white font-medium">${item.name}</td>
                        <td class="py-4 text-center">
                            <div class="flex items-center justify-center gap-2">
                                <button onclick="changeQty(${item.id}, -1)" class="bg-gray-700 w-6 h-6 rounded hover:bg-red-600">-</button>
                                <span class="font-bold">${item.qty}</span>
                                <button onclick="changeQty(${item.id}, 1)" class="bg-gray-700 w-6 h-6 rounded hover:bg-green-600">+</button>
                            </div>
                        </td>
                        <td class="py-4 text-right">${item.price.toFixed(2)}</td>
                        <td class="py-4 text-right text-[#22c55e] font-bold">PKR ${(item.price * item.qty).toFixed(2)}</td>
                        <td class="py-4 text-center">
                            <button onclick="removeFromCart(${item.id})" class="text-red-500 hover:text-red-400 text-lg"><i class="fas fa-trash-alt"></i></button>
                        </td>
                    </tr>`;
            });
            document.getElementById('modal-total-display').innerText = document.getElementById('total-display').innerText;
        }

        function showNotification(message) {
            const toast = document.getElementById('toast-notification');
            document.getElementById('toast-message').innerText = message;
            toast.classList.remove('translate-x-[150%]');
            setTimeout(() => { toast.classList.add('translate-x-[150%]'); }, 3000);
        }

        function renderProducts(itemsToRender = products) {
            const listContainer = document.getElementById('products-list');
            listContainer.innerHTML = '';
            itemsToRender.forEach(p => {
                listContainer.innerHTML += `<div onclick="addToCart(${p.id})" class="bg-[#1e293b] border border-gray-700 py-2.5 px-4 rounded-lg flex justify-between items-center cursor-pointer hover:bg-[#334155] transition-all shadow-sm"><div class="flex items-center gap-3"><div class="w-8 h-8 bg-[#334155] rounded-full flex items-center justify-center text-blue-400 text-sm"><i class="fas fa-pills"></i></div><div><h3 class="font-bold text-white text-sm">${p.name}</h3><div class="text-[11px] text-gray-400">Stock: ${p.stock}</div></div></div><div class="text-[#22c55e] font-bold text-[15px]">PKR ${p.price.toFixed(2)}</div></div>`;
            });
        }

        function filterProducts() {
            const s = document.getElementById('search-input').value.toLowerCase();
            renderProducts(products.filter(p => p.name.toLowerCase().includes(s)));
        }

        function addToCart(productId) {
            const p = products.find(i => i.id === productId);
            const exist = cart.find(i => i.id === productId);
            if (exist) { exist.qty += 1; } else { cart.push({ ...p, qty: 1 }); }
            updateCartUI();
        }

        function removeFromCart(id) {
            cart = cart.filter(i => i.id !== id);
            updateCartUI();
            if (cart.length > 0) updateModalUI(); else closeCartModal();
        }

        function changeQty(id, ch) {
            const i = cart.find(i => i.id === id);
            if (i) { i.qty += ch; if (i.qty <= 0) removeFromCart(id); else { updateCartUI(); updateModalUI(); } }
        }

        function updateCartUI() {
            const container = document.getElementById('cart-items-container');
            if (cart.length === 0) {
                container.innerHTML = `<div class="flex-1 flex flex-col items-center justify-center text-gray-400 h-full"><p class="text-sm">Cart is empty</p></div>`;
            } else {
                container.innerHTML = '';
                cart.forEach(item => {
                    container.innerHTML += `<div class="bg-[#334155] p-3 rounded-lg relative mb-1"><div class="flex justify-between items-start mb-1"><h4 class="text-xs font-bold text-white">${item.name}</h4><button onclick="removeFromCart(${item.id})" class="text-red-400"><i class="fas fa-times text-xs"></i></button></div><div class="flex justify-between items-center"><span class="text-xs text-gray-300">${item.qty} x ${item.price}</span><div class="text-[#22c55e] text-xs font-bold">PKR ${(item.price * item.qty).toFixed(2)}</div></div></div>`;
                });
            }
            calculateTotals();
        }

        function calculateTotals() {
            let sub = 0; cart.forEach(i => sub += (i.price * i.qty));
            const discP = parseFloat(document.getElementById('discount-input').value) || 0;
            const tax = parseFloat(document.getElementById('tax-input').value) || 0;
            const total = (sub + tax) - (sub * discP / 100);
            document.getElementById('subtotal-display').innerText = `PKR ${sub.toFixed(2)}`;
            document.getElementById('total-display').innerText = `PKR ${Math.max(0, total).toFixed(2)}`;
        }

        function printReceipt(sale, cartItems, sub, disc, tax, tot) {
            const doc = document.getElementById('printFrame').contentWindow.document;
            doc.open();
            let h = `<div style="font-family:Courier,monospace; font-size:12px; max-width:280px; margin:0 auto; color:#000; text-align:center;"><h2 style="margin:0;">MEDICAL POS</h2><p>Lahore, Punjab<br>Ph: 0300-0000000</p><hr style="border-top:1px dashed #000; margin:10px 0;"><strong>Inv No:</strong> ${sale.id}<br><strong>Date:</strong> ${sale.date}<br><strong>Customer:</strong> ${sale.customer}<hr style="border-top:1px dashed #000; margin:10px 0;"><table style="width:100%; text-align:left;"><tr><th>Item</th><th style="text-align:right;">Total</th></tr>`;
            cartItems.forEach(i => { h += `<tr><td style="padding:4px 0;">${i.name}<br><small>${i.qty}x${i.price.toFixed(2)}</small></td><td style="text-align:right;">${(i.price * i.qty).toFixed(2)}</td></tr>`; });
            h += `</table><hr style="border-top:1px dashed #000; margin:10px 0;"><table style="width:100%;"><tr><td>Subtotal</td><td style="text-align:right;">${sub.toFixed(2)}</td></tr><tr><td>TOTAL</td><td style="text-align:right; font-weight:bold;">PKR ${tot.toFixed(2)}</td></tr></table><p style="margin-top:15px;">*** Get Well Soon ***</p></div>`;
            doc.write(h); doc.close();
            setTimeout(() => { document.getElementById('printFrame').contentWindow.print(); }, 500);
        }

        function checkout() {
            const name = document.getElementById('pos-customer-input').value.trim();
            if (!name) { document.getElementById('customer-error').classList.remove('hidden'); return; }
            if (cart.length === 0) { alert("Cart is empty!"); return; }

            let sub = 0; cart.forEach(i => sub += (i.price * i.qty));
            const discP = parseFloat(document.getElementById('discount-input').value) || 0;
            const tax = parseFloat(document.getElementById('tax-input').value) || 0;
            const tot = (sub + tax) - (sub * discP / 100);
            const invoiceID = Math.floor(1000000000 + Math.random() * 9000000000).toString();

            const sale = { id: invoiceID, customer: name, date: new Date().toLocaleString('en-GB'), total: "PKR " + tot.toFixed(2), status: "Completed" };
            let history = JSON.parse(localStorage.getItem('pos_sales_history')) || [];
            history.push(sale); localStorage.setItem('pos_sales_history', JSON.stringify(history));

            printReceipt(sale, cart, sub, (sub * discP / 100), tax, tot);
            showNotification("Sale done! Inv: " + invoiceID);
            cart = []; document.getElementById('pos-customer-input').value = ""; closeCartModal(); updateCartUI();
        }

        renderProducts();
    </script>
</body>

</html>